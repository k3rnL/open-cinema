---
- name: Install CamillaDSP build dependencies
  ansible.builtin.apt:
    update_cache: true
    name:
      - curl
      - git
      - build-essential
      - pkg-config
      - libasound2-dev
      - libpulse-dev
    state: present
  when: camilladsp.build_from_source

- name: Check if Rust is installed
  ansible.builtin.command: rustc --version
  register: rust_check
  failed_when: false
  changed_when: false
  when: camilladsp.build_from_source

- name: Install Rust for root user
  ansible.builtin.shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: /root/.cargo/bin/rustc
  when:
    - camilladsp.build_from_source
    - rust_check.rc != 0

- name: Check if CamillaDSP is already installed
  ansible.builtin.stat:
    path: "{{ camilladsp.install_path }}"
  register: camilladsp_binary

- name: Check installed CamillaDSP version
  ansible.builtin.command: "{{ camilladsp.install_path }} --version"
  register: camilladsp_installed_version
  failed_when: false
  changed_when: false
  when: camilladsp_binary.stat.exists

- name: Determine if rebuild is needed
  ansible.builtin.set_fact:
    camilladsp_needs_rebuild: >-
      {{
        not camilladsp_binary.stat.exists or
        (camilladsp_installed_version.stdout is defined and
         camilladsp.version | replace('v', '') not in camilladsp_installed_version.stdout)
      }}

- name: Clone CamillaDSP repository
  ansible.builtin.git:
    repo: "https://github.com/{{ camilladsp.repo }}.git"
    dest: /tmp/camilladsp
    version: "{{ camilladsp.version }}"
    depth: 1
    force: yes
  when:
    - camilladsp.build_from_source
    - camilladsp_needs_rebuild | bool
  register: camilladsp_clone

- name: Build CamillaDSP with PulseAudio support
  ansible.builtin.shell: |
    source /root/.cargo/env
    cargo build --release --features {{ camilladsp.features }}
  args:
    chdir: /tmp/camilladsp
  environment:
    PATH: "/root/.cargo/bin:{{ ansible_facts['env']['PATH'] }}"
  when:
    - camilladsp.build_from_source
    - camilladsp_clone.changed
  register: build_result

- name: Install CamillaDSP binary
  ansible.builtin.copy:
    src: /tmp/camilladsp/target/release/camilladsp
    dest: "{{ camilladsp.install_path }}"
    remote_src: true
    mode: '0755'
  when:
    - camilladsp.build_from_source
    - build_result.changed
  notify: Restart camilladsp

- name: Clean up build directory
  ansible.builtin.file:
    path: /tmp/camilladsp
    state: absent
  when: camilladsp.build_from_source and build_result.changed

- name: Create CamillaDSP config directory
  ansible.builtin.file:
    path: /etc/camilladsp
    state: directory
    owner: "{{ open_cinema.user }}"
    group: "{{ open_cinema.group }}"
    mode: '0755'

- name: Install default CamillaDSP configuration
  ansible.builtin.template:
    src: default.yml.j2
    dest: "{{ camilladsp.config_path }}"
    owner: "{{ open_cinema.user }}"
    group: "{{ open_cinema.group }}"
    mode: '0644'
  notify: Restart camilladsp

- name: Install CamillaDSP systemd service
  ansible.builtin.template:
    src: camilladsp.service.j2
    dest: /etc/systemd/system/camilladsp.service
    mode: '0644'
  notify: Restart camilladsp

- name: Enable and start CamillaDSP
  ansible.builtin.systemd:
    name: camilladsp
    enabled: true
    state: started
    daemon_reload: true
